@page "/Market/MarketMain"
@using Warf_MAUI.Shared.Common.BM25
@using Warf_MAUI.Shared.Common.Extensions
@using Warf_MAUI.Shared.Common.Search.Models
@using Warf_MAUI.Shared.Common.WebAPI.WebClients
@using Warf_MAUI.Shared.Common.WebAPI.WebClients.MyWarframeApiClient.Models
@using Warf_MAUI.Shared.Common.WebAPI.WebClients.MyWarframeApiClient.Models.Enums


<div class="uk-panel-box uk-border-rounded uk-padding">
    <div class="uk-panel-box-primary uk-border-rounded uk-width-1-3 uk-container-center uk-position-relative">
        <input class="uk-search-field uk-width-1-1"
               type="search"
               placeholder="Поиск..."
               @bind="SearchText"
               @bind:event="oninput"
               autocomplete="off">

        @if (filteredItems.Any())
        {
            <div class="uk-panel-box-secondary uk-border-rounded uk-box-shadow-medium
                uk-position-absolute uk-width-1-1
                uk-animation-scale-up uk-transform-origin-top-center
                uk-padding-small" style="z-index: 1000;">

                <ul class="uk-list uk-grid-small uk-child-width-1-2@m uk-child-width-1-1@s uk-grid-match uk-list-divider custom-list"  uk-grid>
                    @foreach (var item in filteredItems)
                    {
                        <li class="uk-padding-small uk-transition-toggle list-item"
                            @onclick="() => SelectItem(item)">
                            <Warf_MAUI.Shared.Components.Item.SearchItemCard Item="item" />
                        </li>
                    }
                </ul>
            </div>
        }
    </div>
</div>
<div class="uk-child-width-small uk-margin-top uk-margin-remove-left uk-padding uk-column-1-2" uk-grid>
    <div class="uk-panel-box uk-border-rounded">
           @*  @foreach (var item in shownItems)
            {
                <li class="uk-width-1-6">
                    <span>@item.Name</span>
                </li>
            } *@
        <div>
            <table class="uk-table uk-table-hover uk-table-striped uk-table-condensed uk-table-responsive">
                <caption>
                </caption>
                <thead>
                    <tr>
                        <th>
                            Изображение
                        </th>
                        <th>
                            Название
                        </th>
                        <th>
                            Цена покупки
                        </th>
                        <th>
                            Цена продажи
                        </th>
                        <th>
                            Разница цен
                        </th>
                        <th>
                            Действия
                        </th>
                    </tr>
                </thead>
                <tbody>
                    @foreach(var Item in shownItems)
                    {
                        <tr class="">
                            <td>
                                <img class="uk-margin-small-right"
                                     src="@GetImage.GetItemImageUrl(Item)"
                                     alt="@Item.Name" width="48" height="48" />
                            </td>
                            <td>
                                <div class="uk-text-bold uk-text-truncate item-name">@Item.Name</div>

                                @if (!string.IsNullOrWhiteSpace(Item.Subtype))
                                {
                                    <div class="uk-text-meta">Подтип: @Item.Subtype</div>
                                }

                                @if (Item.Rank != null)
                                {
                                    <div class="uk-text-muted">Ранг: @Item.Rank</div>
                                }
                            </td>
                            <td>
                                тест цена покупки
                            </td>
                            <td>
                                тест цена продажи
                            </td>
                            <td>
                                тест разница
                            </td>
                            <td>
                                <div>
                                    <button class="uk-button uk-button-primary uk-button-small uk-margin-small-right">
                                        Купить
                                    </button>
                                    <button class="uk-button uk-button-secondary uk-button-small">
                                        Продать
                                    </button>
                                </div>
                            </td>
                            @* временное тестовое решение *@
                            <td>
                                <button class="uk-button uk-button-default demo" type="button" onclick="UIkit.notification({message: 'Message',timeout: 0,close: false})">With icon</button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
    <div class="uk-panel-box uk-border-rounded">

    </div>
</div>

<style>
.custom-list {
    max-height: 60vh;
    overflow-y: auto;
    scrollbar-width: thin;
    scrollbar-color: #aaa transparent;
}

/* hover эффект для всего li */
.list-item {
    cursor: pointer;
    transition: background-color 0.2s ease, transform 0.1s ease;
    border-top: 0px !important;
}

.list-item:hover {
    background-color: rgba(255, 255, 255, 0.08);
    transform: translateY(-2px);
}

/* убираем стандартные отступы у li */
.list-item img {
    flex-shrink: 0;
}

/* адаптивная высота и прокрутка */
.custom-list::-webkit-scrollbar {
    width: 6px;
}

.custom-list::-webkit-scrollbar-thumb {
    background-color: #aaa;
    border-radius: 3px;
}

.border-remove {

}

</style>

@inject CombinedApiClient _apiClient;
@code {
    private string searchText = string.Empty;
    private List<SearchItem> allItems = new();
    private List<SearchItem> shownItems = new();
    private List<SearchItem> filteredItems = new();

    private BM25Searcher<SearchItem> _bm25Searcher = new();
    private CancellationTokenSource _searchFieldCancellationTokenSource = new();

    protected override async Task OnInitializedAsync()
    {
        _ = Task.Run(async () => await Init());
    }

    private async Task Init()
    {
        await LoadItemsFromApi();
        await InitializeSearch();
    }

    private async Task LoadItemsFromApi()
    {
        var res = await _apiClient.My.GetDetailsAsync();

        allItems = ConvertItemsForSearch(res).ToList();
    }

    private IEnumerable<SearchItem> ConvertItemsForSearch(IEnumerable<ItemShort> items)
    {
        var searchItems = new List<SearchItem>();
        foreach(var i in items)
        {
            var existRank = i.MaxRank.HasValue;
            var existSubtype = i.Subtypes!= null;
            if(existRank)
            {
                var searchItemMaxR = new SearchItem() { 
                    Id = i.Id,
                    slug = i.Slug,
                    Name = i.Name,
                    Icon = i.I18n.First().Value.Icon!,
                    Rank = i.MaxRank!.Value,
                    Tags = i.Tags!,
                    SubIcon = i.I18n.First().Value.SubIcon!
                };
                searchItems.Add(searchItemMaxR);

                var searchItemMinR = new SearchItem(){
                    Id = i.Id,
                    slug = i.Slug,
                    Name = i.Name,
                    Icon = i.I18n.First().Value.Icon!,
                    Rank = 0,
                    Tags = i.Tags!,
                    SubIcon = i.I18n.First().Value.SubIcon!
                };
                searchItems.Add(searchItemMinR);
            }
            else if(existSubtype)
            {
                foreach(var subtype in i.Subtypes!)
                {
                    var searchItem = new SearchItem()
                    {
                        Id = i.Id,
                        slug = i.Slug,
                        Name = i.Name,
                        Icon = i.I18n.First().Value.Icon!,
                        Subtype = subtype,
                        Tags = i.Tags!,
                        SubIcon = i.I18n.First().Value.SubIcon!
                    };
                    searchItems.Add(searchItem);
                }
            }
            else
            {
                var searchItem = new SearchItem()
                {
                    Id = i.Id,
                    slug = i.Slug,
                    Name = i.Name,
                    Icon = i.I18n.First().Value.Icon!,
                    Tags = i.Tags!,
                    SubIcon = i.I18n.First().Value.SubIcon!
                };
                searchItems.Add(searchItem);
            }
        }
        return searchItems;
    }

    private async Task InitializeSearch()
    {
        _bm25Searcher.Clear();
        await _bm25Searcher.AddItems(allItems);
    }

    private async Task OnSearchFieldInput(string query)
    {
        await _searchFieldCancellationTokenSource.CancelAsync();
        _searchFieldCancellationTokenSource = new();

        await Task.Delay(150);
        if (_searchFieldCancellationTokenSource.IsCancellationRequested) return;
        await Task.Delay(500);

        if (string.IsNullOrWhiteSpace(query))
        {
            filteredItems.Clear();
            await InvokeAsync(StateHasChanged);
            return;
        }


        var results = await _bm25Searcher.Search(query);
        filteredItems = results.Take(10).ToList();
        await InvokeAsync(StateHasChanged);
    }

    private string SearchText
    {
        get => searchText;
        set
        {
            searchText = value;
            _ = OnSearchFieldInput(value);
        }
    }

    private void SelectItem(SearchItem item)
    {
        searchText = string.Empty;
        filteredItems.Clear();
        shownItems.Add(item); // показать выбранный
    }
}